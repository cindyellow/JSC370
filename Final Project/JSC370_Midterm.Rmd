---
title: "Food Industry During the Pandemic"
subtitle: "JSC370 Midterm Report"
author: "Shih-Ting (Cindy) Huang"
date: "02/27/2022"
output: 
  html_document:
    theme: lumen
    highlight: tango
---
```{r, message=FALSE, warning=FALSE, echo=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=FALSE)
```


## Introduction 

After the emergence of COVID-19 in early 2020, undoubtedly many businesses were forced to close temporarily or permanently. Throughout this time, restaurants in particular have undergone various modifications, such as disabling dine-in, starting takeout, etc. As a result, the food quality, service quality, and overall dining experience might have changed - whether in a positive or negative way. 

With that in mind, I propose the research question: How has COVID-19 affected restaurant performance and impression?

In order to answer this question, I utilized data from Yelp, one of the biggest platforms that displays information of businesses and enable users to search for, react to, and/or share their opinions of such businesses. Their data come from a total of 6,990,280 reviews and 150,346 businesses from 11 metropolitan areas - Montreal, Calgary, Toronto, Pittsburgh, Charlotte, Urbana-Champaign, Phoenix, Las Vegas, Madison, and Cleveland. Only reviews that are [recommended](https://www.yelp-support.com/Recommended_Reviews) by Yelp are included. For privacy reasons, contents of the dataset will not be disclosed.


## Methods

### Data Access

The data were retrieved directly from [Yelp's Open Dataset](https://www.yelp.com/dataset) in a `.tar` compressed file. Extracting the respective json files and converting each to csv using Python, we selected two relevant datasets - `business` and `review`, which provides details on a business and a review respectively. Since we are observing the impact of COVID-19, we decided to only take reviews from the most recent five years (starting at 2017/01/01) and limit data size. 

```{r setup}
library(data.table)
library(tidyverse)
library(dplyr)
library(leaflet)
```

```{r}
bus <- data.table::fread("yelp_business.csv")
rev <- data.table::fread("yelp_reviews.csv")
```

First, we take a look at what variables are present in each dataset. For `business`, we have:

```{r}
tibble("Variable Name" = c(colnames(bus)[1], colnames(bus)[2], colnames(bus)[3], colnames(bus)[4], colnames(bus)[5], colnames(bus)[6], colnames(bus)[7], colnames(bus)[8], colnames(bus)[9], colnames(bus)[10], colnames(bus)[11], colnames(bus)[12], colnames(bus)[13], colnames(bus)[14]),
       Definition = c("22 character unique string business ID (str)", "Business's name (str)", "Full address of the business (str)", "City (str)", "2 character state code, if applicable (str)", "Postal code (str)", "Latitude (dbl)", "Longitude (dbl)", "Star rating from 0.0-5.0, rounded to half-stars (int)", "Number of reviews (int)", "Binary indicator for if business is open (=1) or closed (=0) (int)", "A list of features associated with the business and whether it is available (True) or unavailable (False) (dict[str][bool])", "Categories that the business belongs to (str)", "Business operating hours on a 24-hr clock (str[dict])")) %>%
  knitr::kable(caption = "Yelp Business Variable Definitions, obtained and modified from Yelp Dataset Documentation")
```


Next, we take a look at the `review` dataset:
```{r}
tibble("Variable Name" = c(colnames(rev)[2], colnames(rev)[3], colnames(rev)[4], colnames(rev)[5], colnames(rev)[6]),
       Definition = c("22 character unique review id (str)", "22 character unique user id (str)", "22 character business id, maps to those in business dataset (str)", "Star rating (int)", "Date formatted YYYY-MM-DD (str)")) %>%
  knitr::kable(caption = "Yelp Review Variable Definitions, obtained and modified from Yelp Dataset Documentation")
```



### Data Wrangling

In order to better utilize the data for our research question, we will seek to wrangle the data as necessary.

#### Filtering Observations

Since we are only focusing on restaurant performance, we eliminated non-restaurant business in the `business` dataset and their corresponding reviews, retaining only those that are under the categories "Restaurants" or "Food". The list of categories that Yelp offers can be found [here](https://blog.yelp.com/businesses/yelp_category_list/). 

```{r}
# Modify business dataset
orig_dim_bus <- dim(bus)[1]
bus <- bus %>%
  subset(grepl("Restaurants", categories)) %>%
  subset(grepl("Food", categories))
mod_dim_bus <- dim(bus)[1]
```

```{r}
# Modify review dataset
# Obtain the restaurant business ids
restaurant_ids <- unique(bus$business_id)
orig_dim_rev <- dim(rev)[1]
rev <- rev %>%
  subset(business_id %in% restaurant_ids)
mod_dim_rev <- dim(rev)[1]
```

Originally, we have `r orig_dim_bus` businesses and `r orig_dim_rev` reviews, and after filter we reduced to `r mod_dim_bus` food businesses with `r mod_dim_rev` reviews total. 

#### Ensure validity of data in each observation

```{r}
# Doublecheck data format 
state_prob <- bus %>%
  subset(!grepl("[a-zA-Z]{2}", state))

star_prob_rev <- rev %>%
  subset(!(stars %in% seq(0, 5, by=0.5)))

star_prob_bus <- bus %>%
  subset(!(stars %in% seq(0, 5, by=0.5)))

postal_prob <- bus %>%
  subset(!grepl("[0-9]+", postal_code) & !grepl("[A-Z][0-9][A-Z] [0-9][A-Z][0-9]", postal_code))

coord_prob <- bus %>%
  subset(!between(latitude, -90, 90) | !between(longitude, -180, 180))

rev_prob <- bus %>%
  subset(review_count < 0)

is_open_prob <- bus %>%
  subset(!(is_open %in% c(0,1)))

is.POSIXct <- function(x) inherits(x, "POSIXct")
date_prob <- rev %>%
  subset(!is.POSIXct(date))
```

```{r, eval=FALSE}
# Check where the problems are
dim(is_open_prob)[1] 
dim(rev_prob)[1] 
dim(coord_prob)[1] 
dim(postal_prob)[1] 
dim(star_prob_bus)[1] 
dim(star_prob_rev)[1] 
dim(state_prob)[1] 
dim(date_prob)[1]

# Check what the problem is by looking at the unique values
unique(postal_prob$postal_code)
```

Checking potential problems with the data types, we verify that there are `r dim(postal_prob)[1]` problems total, all of which arise from variable `postal_code` with the value "". 

#### Checking for NAs

As previously determined, we notice that the datasets represent missing values as an empty string "", and below we showcase how many there are for each variable after converting "" to take on value `NA`:

```{r}
# Convert empty strings to NA
bus <- as.data.frame(lapply(bus, function(x) replace(x,x == "", NA)))
rev[,2:5] <- as.data.frame(lapply(rev[,2:5], function(x) replace(x, x == "",NA)))
# Table of NAs
na_bus <- apply(bus, 2, function(col)round(sum(is.na(col))/length(col),8))
na_rev <- apply(rev, 2, function(col)round(sum(is.na(col))/length(col),3))
```

```{r}
library(kableExtra)

kable(na_bus, col.names = c("Proportion"), caption = "Summary of NA Proportion for All Variables (Yelp Business)") %>%
  kable_styling("striped", full_width = F) %>% 
 scroll_box(width = "100%", height = "200px")

kable(na_rev, col.names = c("Proportion"), caption = "Summary of NA Proportion for All Variables (Yelp Reviews)") %>%
  kable_styling("striped", full_width = F) %>% 
 scroll_box(width = "100%", height = "200px")
```


We notice that there are no missing values in `review`; however, in `business`, `NA`s are present in the variables `address`, `postal_code`, `attributes`, `categories`, and `hours`. Since these variables are unique to the restaurant and cannot be simply inferred from observations with non-missing values, we will keep them as NAs in the dataset as they may have particular association with other characteristics.


In order to extract more information from our dataset, we will generated additional features from existing ones that may be helpful for our data exploration and analysis.

First, we try to identify businesses that opened before and after COVID-19. For the purpose of this research, we define the start of the pandemic as January 9th, 2020, which is when WHO reported globally that there has been a [new coronavirus identified](https://www.who.int/emergencies/diseases/novel-coronavirus-2019/interactive-timeline#event-7).

```{r}
# Function to find earliest review date for business
find_earliest <- function(bus_id, rev_data){
  all_rev <- rev_data %>% 
    subset(business_id == bus_id)
  return(min(all_rev$date))
}

# Binary Pre-COVID (=1), Post-COVID (=0), and Unknown (=2)
# We use the date of the earliest review for each business
startDate = as.POSIXct("2020-01-09")
bus$pre_covid <- fifelse(bus$business_id %in% rev$business_id, fifelse(find_earliest(bus$business_id, rev) <= startDate, 1, 0), 2)
```

We then add a couple of other variables by extracting information from `attributes` and `hours`, which are dictionaries of restaurant features and open hours respectively. For indicator variables, we assigned the value 2 for unknown because the lack of such information could reveal insights about the restaurant performance as well. At this point, all of the variables we have added are: 
* `pre_covid`: indicator for if restaurant did (=1) or did not open (=0) before COVID-19, or unknown (=2) based on their first review (int)
* `avg_hours`: the daily average open hours (float)
* `takeout`: indicator for if restaurant does (=1) or does not offer (=0) takeout, or unknown (=2) (int)
* `good_for_groups`: indicator for if restaurant is (=1) or is not (=0) good for groups, or unknown (=2) (int)
* `outdoors`: indicator for if restaurant does (=1) or does not offer (=0) outdoor seating, or unknown (=2) (int)
* `delivery`: indicator for if restaurant does (=1) or does not offer (=0) delivery, or unknown (=2) (int)
* `price_range`: restaurant price range from 1-4 (int)

```{r, warning=FALSE}
# Float: average length of open hours
avg_hours <- c()
for (hours in bus$hours){
  hours <- str_remove_all(hours, "[{}]")
  days <- strsplit(hours, ", ")
  num_days <- 0
  total_length <- 0
  for (day in days){
    for(d in day){
      num_days <- num_days + 1
      # Extracts the first instance for open hours and closing hours of each day
      open <- as.integer(str_remove(str_extract(d, "[0-9]+(:)"), "[:]"))
      close <- as.integer(str_remove(str_extract(d, "(-)[0-9]+"), "[-]"))
      if(is.na(open) | is.na(close)){
        next
      }
      if (close > open){
        total_length <- total_length + (close - open)
      } else {
        total_length <- total_length + (close + 24 - open)
      }
    }
  }
  avg_hours <- c(avg_hours, total_length/num_days)
}
  
bus$avg_hours <- avg_hours

# Binary: takeout
vals <- c()
for (b in bus$attributes){
  all <- str_remove_all(b, "[{}]")
  attr <- strsplit(all, ", ")
  val <- 2
  for (i in 1:length(attr)){
    if (grepl('RestaurantsTakeOut', attr[i])){
      if (grepl('True', attr[i])){
        val <- 1
      } else{
        val <- 0
      }
    }
  }
  vals <- c(vals, val)
  
}
bus$takeout <- vals

# Binary: good for groups
vals <- c()
for (b in bus$attributes){
  all <- str_remove_all(b, "[{}]")
  attr <- strsplit(all, ", ")
  val <- 2
  for (i in 1:length(attr)){
    if (grepl('RestaurantsGoodForGroups', attr[i])){
      if (grepl('True', attr[i])){
        val <- 1
      } else{
        val <- 0
      }
    }
  }
  vals <- c(vals, val)
  
}
bus$good_for_groups <- vals

# Binary: outdoor seating
vals <- c()
for (b in bus$attributes){
  all <- str_remove_all(b, "[{}]")
  attr <- strsplit(all, ", ")
  val <- 2
  for (i in 1:length(attr)){
    if (grepl('OutdoorSeating', attr[i])){
      if (grepl('True', attr[i])){
        val <- 1
      } else{
        val <- 0
      }
    }
  }
  vals <- c(vals, val)
  
}
bus$outdoors <- vals

# Binary: delivery (false, none, true)
vals <- c()
for (b in bus$attributes){
  all <- str_remove_all(b, "[{}]")
  attr <- strsplit(all, ", ")
  val <- 2
  for (i in 1:length(attr)){
    if (grepl('RestaurantsDelivery', attr[i])){
      if (grepl('True', attr[i])){
        val <- 1
      } else{
        val <- 0
      }
    }
  }
  vals <- c(vals, val)
  
}
bus$delivery <- vals

# Categorical: price range
vals <- c()
for (b in bus$attributes){
  all <- str_remove_all(b, "[{}]")
  attr <- strsplit(all, ", ")
  for (i in 1:length(attr)){
    if (grepl('RestaurantsPriceRange2', attr[i])){
      val <- as.integer(str_remove_all(str_extract(attr[i], "(: ')[0-5](')"), "[:']"))
    }
  }
  vals <- c(vals, val)
  
}
bus$price_range <- vals

# Multiple visits -> can users only post once?
# Categorical: Cuisines, Fast Food, (check what categories there are)
```

### Tools used 
Data wrangling were completed with `tidyverse` and `dplyr`. All figures were created with `ggplot2`, and maps were created using `leaflet`

* how and where the data were acquired
* how you cleaned and wrangled the data
* what tools you used for data exploration

## Preliminary Results
* summary statistics
```{r}
# histograms
```

```{r}
# bar charts
```

```{r}
# Distribution of restaurants
```


## Conclusion
* what i found in terms of the question




```{r, message=FALSE, warning=FALSE, echo=FALSE, eval=FALSE}
head(bus)
head(rev)
```
```{r}
rev$Year <- format(rev$date, format="%Y")
```























