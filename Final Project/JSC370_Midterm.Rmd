---
title: "Food Industry During the Pandemic"
subtitle: "JSC370 Midterm Report"
author: "Shih-Ting (Cindy) Huang"
date: "02/27/2022"
output: 
  html_document:
    theme: lumen
    highlight: tango
---
```{r, message=FALSE, warning=FALSE, echo=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=FALSE)
```


## Introduction 

After the emergence of COVID-19 in early 2020, undoubtedly many businesses were forced to close temporarily or permanently. Throughout this time, restaurants in particular have undergone various modifications, such as disabling dine-in, starting takeout, etc. As a result, the food quality, service quality, and overall dining experience might have changed - whether in a positive or negative way. 

With that in mind, I propose the research question: How has COVID-19 affected restaurant performance and impression?

In order to answer this question, I utilized data from Yelp, one of the biggest platforms that displays information of businesses and enable users to search for, react to, and/or share their opinions of such businesses. Their data come from a total of 6,990,280 reviews and 150,346 businesses from 11 metropolitan areas - Montreal, Calgary, Toronto, Pittsburgh, Charlotte, Urbana-Champaign, Phoenix, Las Vegas, Madison, and Cleveland. Only reviews that are [recommended](https://www.yelp-support.com/Recommended_Reviews) by Yelp are included. For privacy reasons, contents of the dataset will not be disclosed.


## Methods
### Data Access
The data were retrieved directly from [Yelp's Open Dataset](https://www.yelp.com/dataset) in a `.tar` compressed file. Extracting the respective json files and converting each to csv using Python, we selected two relevant datasets - `business` and `review`, which provides details on a business and a review respectively. Since we are observing the impact of COVID-19, we decided to only take reviews from the most recent five years (starting at 2017/01/01) and limit data size. 

```{r setup}
library(data.table)
library(tidyverse)
library(dplyr)
library(leaflet)
```

```{r}
bus <- data.table::fread("yelp_business.csv")
rev <- data.table::fread("yelp_reviews.csv")
```

First, we take a look at what variables are present in each dataset. For `business`, we have:

```{r}
tibble("Variable Name" = c(colnames(bus)[1], colnames(bus)[2], colnames(bus)[3], colnames(bus)[4], colnames(bus)[5], colnames(bus)[6], colnames(bus)[7], colnames(bus)[8], colnames(bus)[9], colnames(bus)[10], colnames(bus)[11], colnames(bus)[12], colnames(bus)[13], colnames(bus)[14]),
       Definition = c("22 character unique string business ID (str)", "Business's name (str)", "Full address of the business (str)", "City (str)", "2 character state code, if applicable (str)", "Postal code (str)", "Latitude (dbl)", "Longitude (dbl)", "Star rating from 0.0-5.0, rounded to half-stars (int)", "Number of reviews (int)", "Binary indicator for if business is open (=1) or closed (=0) (int)", "A list of features associated with the business and whether it is available (True) or unavailable (False) (dict[str][bool])", "Categories that the business belongs to (str)", "Business operating hours on a 24-hr clock (str[dict])")) %>%
  knitr::kable(caption = "Yelp Business Variable Definitions, obtained and modified from Yelp Dataset Documentation")
```


Next, we take a look at the `review` dataset:
```{r}
tibble("Variable Name" = c(colnames(rev)[2], colnames(rev)[3], colnames(rev)[4], colnames(rev)[5], colnames(rev)[6]),
       Definition = c("22 character unique review id (str)", "22 character unique user id (str)", "22 character business id, maps to those in business dataset (str)", "Star rating (int)", "Date formatted YYYY-MM-DD (str)")) %>%
  knitr::kable(caption = "Yelp Review Variable Definitions, obtained and modified from Yelp Dataset Documentation")
```



### Data Wrangling
In order to better utilize the data for our research question, we will seek to wrangle the data as necessary.

#### Ensure validity of data in each observation

```{r}
# Doublecheck data format 
# Problem with state variable
state_prob <- bus %>%
  subset(!grepl("[a-zA-Z]{2}", state))

sel <- rev %>%
  subset((stars %in% c(0,0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0)))

```

```{r}
date_prob <- rev %>%
  subset(!(date))
```

```{r}
is.POSIXct <- function(x) inherits(x, "POSIXct")

is.POSIXct(rev[1]$date)

```

#### Checking for NAs
We notice that the datasets represent missing values as an empty string "", and below we showcase how many there are for each variable:

```{r}
# Convert empty strings to NA
bus <- as.data.frame(lapply(bus, function(x) replace(x,x == "", NA)))
rev[,2:5] <- as.data.frame(lapply(rev[,2:5], function(x) replace(x, x == "",NA)))
# Table of NAs
na_bus <- apply(bus, 2, function(col)round(sum(is.na(col))/length(col),8))
na_rev <- apply(rev, 2, function(col)round(sum(is.na(col))/length(col),3))
```

```{r}
library(kableExtra)

kable(na_bus, col.names = c("Proportion"), caption = "Summary of NA Proportion for All Variables (Yelp Business)") %>%
  kable_styling("striped", full_width = F) %>% 
 scroll_box(width = "100%", height = "200px")

kable(na_rev, col.names = c("Proportion"), caption = "Summary of NA Proportion for All Variables (Yelp Reviews)") %>%
  kable_styling("striped", full_width = F) %>% 
 scroll_box(width = "100%", height = "200px")
```

```{r}
sum(is.na(bus$business_id))
sum(is.na(bus$name))
sum(is.na(bus$city))
sum(is.na(bus$state))
sum(is.na(bus$latitude))
sum(is.na(bus$longitude))
sum(is.na(bus$stars))
sum(is.na(bus$review_count))
sum(is.na(bus$is_open))
```

We notice that there are no missing values in `review`; however, in `business`, 
```{r, eval=FALSE}
chs[, father_asthma  := fifelse(is.na(father_asthma), avg_val, father_asthma)]
sum(is.na(bus))
sum(is.na(rev))
```

#### Filtering Observations
Since we are only focusing on restaurant performance, we eliminated non-restaurant business in the `business` dataset and their corresponding reviews, retaining only those that are under the categories "Restaurants" or "Food". The list of categories that Yelp offers can be found [here](https://blog.yelp.com/businesses/yelp_category_list/). 

```{r}
# Modify business dataset
orig_dim_bus <- dim(bus)[1]
bus <- bus %>%
  subset(grepl("Restaurants", categories)) %>%
  subset(grepl("Food", categories))
mod_dim_bus <- dim(bus)[1]
```

```{r}
# Modify review dataset
# Obtain the restaurant business ids
restaurant_ids <- unique(bus$business_id)
orig_dim_rev <- dim(rev)[1]
rev <- rev %>%
  subset(business_id %in% restaurant_ids)
mod_dim_rev <- dim(rev)[1]
```

Originally, we have `r orig_dim_bus` businesses and `r orig_dim_rev` reviews, and after filter we reduced to `r mod_dim_bus` food businesses with `r mod_dim_rev` reviews total. 


In order to extract more information from our dataset, we will generated additional features from existing ones that may be helpful for our data exploration and analysis.

First, we try to identify businesses that opened before and after COVID-19. For the purpose of this research, we define the start of the pandemic as January 9th, 2020, which is when WHO reported globally that there has been a [new coronavirus identified](https://www.who.int/emergencies/diseases/novel-coronavirus-2019/interactive-timeline#event-7).

```{r}
# function to find earliest review date for business
find_earliest <- function(bus_id, rev_data){
  all_rev <- rev_data %>% 
    subset(business_id == bus_id)
  min(all_rev$date)
}
```



```{r}
# Binary Pre-COVID (=1), Post-COVID (=0), and Unknown (=2)
# We use the date of the earliest review for each business
startDate = as.POSIXct("2020-01-09");
bus[, pre_covid := fifelse(business_id %in% rev$business_id, fifelse(find_earliest(business_id, rev) <= startDate, 1, 0), 2)]

# Int: length of open hours


# Binary: takeout

# Binary: good for groups

# Binary: outdoor seating

# Binary: delivery (false, none, true)

# Categorical: Cuisines, Fast Food, (check what categories there are)

# Categorical: price range

# Multiple visits -> can users only post once?
```

```{r}
head(bus)
```
```{r}
sel <- bus %>% subset(business_id == "eEOYSgkmpB90uNA7lDOMRA") %>% select(address)
sel == ""
```


```{r}
for (i in len(rev))
```


### Tools used 
Data wrangling were completed with `tidyverse` and `dplyr`. All figures were created with `ggplot2`.

* how and where the data were acquired
* how you cleaned and wrangled the data
* what tools you used for data exploration

## Preliminary Results
* summary statistics
```{r}
# histograms
```

```{r}
# bar charts
```


## Conclusion
* what i found in terms of the question




```{r, message=FALSE, warning=FALSE, echo=FALSE, eval=FALSE}
head(bus)
head(rev)
```
```{r}
rev$Year <- format(rev$date, format="%Y")
```























